@startuml
autonumber
skinparam Style strictuml

participant "Client" as Client
participant "Controller" as Controller
participant "BatchJob" as BatchJob
participant "Reader" as Reader
participant "SftpPool" as SftpPool
participant "Processor" as Processor
participant "Writer" as Writer
database "MongoDB" as MongoDB

Client -> Controller : POST /api/batch/index/full
Controller -> BatchJob : Lanzar con ShedLock

note over BatchJob : Phase 1: Discovery
BatchJob -> Reader : Descubrir directorios
Reader -> SftpPool : Obtener sesión (1 vez)
SftpPool -->> Reader : Queue de directorios

note over BatchJob : Phase 2: Indexing
loop Por cada chunk de 500 archivos
    Reader -> SftpPool : Obtener sesión
    SftpPool -->> Reader : Archivos del directorio
    
    par Procesamiento paralelo (20 threads)
        Reader -> Processor : SftpFileEntry[]
        Processor -> Processor : Extraer metadata
    end
    
    par Escritura paralela
        Processor -> Writer : ArchivoMetadata[]
        Writer -> MongoDB : Bulk upsert (500 docs)
    end
end

BatchJob -->> Controller : JobExecutionId
Controller -->> Client : 202 Accepted

@enduml